name: Claude Auto Workflow (Complete Automation)

on:
  workflow_run:
    workflows: ["Claude Code"]
    types: [completed]
    branches: [main]

jobs:
  # Claude Codeãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æˆåŠŸã‚’æ¤œè¨¼ã—ã€è‡ªå‹•PRä½œæˆã‚’å®Ÿè¡Œ
  auto-create-pr:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      metadata: read
      checks: read
      id-token: write
    
    outputs:
      pr_created: ${{ steps.create-pr.outputs.created }}
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      issue_number: ${{ steps.extract-context.outputs.issue_number }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        # GitHub Appã®Tokenã‚’ä½¿ç”¨ï¼ˆã‚ˆã‚Šå¼·ã„æ¨©é™ï¼‰
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract workflow context and issue information
      id: extract-context
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const workflowRun = context.payload.workflow_run;
          
          console.log('Workflow Run Info:', {
            id: workflowRun.id,
            name: workflowRun.name,
            conclusion: workflowRun.conclusion,
            head_branch: workflowRun.head_branch,
            head_sha: workflowRun.head_sha,
            event: workflowRun.event,
            actor: workflowRun.actor?.login
          });
          
          let issueNumber = null;
          let triggerType = 'unknown';
          
          // 1. PRã‹ã‚‰å®Ÿè¡Œã•ã‚ŒãŸå ´åˆ
          if (workflowRun.pull_requests && workflowRun.pull_requests.length > 0) {
            issueNumber = workflowRun.pull_requests[0].number;
            triggerType = 'pull_request';
          }
          // 2. ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰issueç•ªå·ã‚’æŠ½å‡º
          else if (workflowRun.head_branch) {
            const branchPatterns = [
              /issue-(\d+)/,
              /fix\/issue-(\d+)/,
              /feature\/issue-(\d+)/,
              /claude\/issue-(\d+)/,
              /#(\d+)/
            ];
            
            for (const pattern of branchPatterns) {
              const match = workflowRun.head_branch.match(pattern);
              if (match) {
                issueNumber = parseInt(match[1]);
                triggerType = 'issue_branch';
                break;
              }
            }
          }
          
          // 3. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã®è©³ç´°ã‹ã‚‰issueæƒ…å ±ã‚’å–å¾—
          if (!issueNumber && workflowRun.id) {
            try {
              const jobs = await github.rest.actions.listJobsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: workflowRun.id
              });
              
              // ã‚¸ãƒ§ãƒ–ãƒ­ã‚°ã‹ã‚‰issueç•ªå·ã‚’æ¤œç´¢ï¼ˆClaude Code actionãŒä½œæˆã™ã‚‹ãƒ­ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æƒ³å®šï¼‰
              for (const job of jobs.data.jobs) {
                if (job.name.includes('claude')) {
                  const logMatch = job.name.match(/issue[:\s#]*(\d+)/i);
                  if (logMatch) {
                    issueNumber = parseInt(logMatch[1]);
                    triggerType = 'job_log';
                    break;
                  }
                }
              }
            } catch (error) {
              console.log('Could not fetch workflow jobs:', error.message);
            }
          }
          
          console.log(`Extracted context: issueNumber=${issueNumber}, triggerType=${triggerType}`);
          
          return {
            issueNumber,
            triggerType,
            workflowId: workflowRun.id,
            headBranch: workflowRun.head_branch,
            headSha: workflowRun.head_sha,
            actor: workflowRun.actor?.login
          };
    
    - name: Find and validate Claude-created branch
      id: find-branch
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const context_data = ${{ steps.extract-context.outputs.result }};
          const issueNumber = context_data.issueNumber;
          const headBranch = context_data.headBranch;
          
          if (!issueNumber) {
            console.log('No issue number found, cannot create PR');
            return { found: false };
          }
          
          // ãƒ–ãƒ©ãƒ³ãƒã®å­˜åœ¨ç¢ºèª
          let targetBranch = headBranch;
          let branchExists = false;
          
          try {
            const branch = await github.rest.repos.getBranch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: targetBranch
            });
            branchExists = true;
            console.log(`Branch ${targetBranch} exists`);
          } catch (error) {
            console.log(`Branch ${targetBranch} not found, searching for alternatives...`);
            
            // ä»£æ›¿ãƒ–ãƒ©ãƒ³ãƒã‚’æ¤œç´¢
            const candidateBranches = [
              `claude/issue-${issueNumber}`,
              `fix/issue-${issueNumber}`,
              `feature/issue-${issueNumber}`,
              `issue-${issueNumber}`,
              `claude-${issueNumber}`
            ];
            
            for (const candidate of candidateBranches) {
              try {
                await github.rest.repos.getBranch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  branch: candidate
                });
                targetBranch = candidate;
                branchExists = true;
                console.log(`Found alternative branch: ${candidate}`);
                break;
              } catch (e) {
                // ãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã—ãªã„
              }
            }
          }
          
          // ãƒ–ãƒ©ãƒ³ãƒãŒmainã¨ç•°ãªã‚‹ã‚³ãƒŸãƒƒãƒˆã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          let hasChanges = false;
          if (branchExists) {
            try {
              const comparison = await github.rest.repos.compareCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                base: 'main',
                head: targetBranch
              });
              hasChanges = comparison.data.ahead_by > 0;
              console.log(`Branch ${targetBranch} is ${comparison.data.ahead_by} commits ahead of main`);
            } catch (error) {
              console.log('Could not compare branches:', error.message);
            }
          }
          
          return {
            found: branchExists,
            hasChanges,
            branchName: targetBranch,
            issueNumber
          };
    
    - name: Create automatic pull request
      id: create-pr
      if: steps.find-branch.outputs.result && fromJSON(steps.find-branch.outputs.result).found && fromJSON(steps.find-branch.outputs.result).hasChanges
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const branchInfo = ${{ steps.find-branch.outputs.result }};
          const contextInfo = ${{ steps.extract-context.outputs.result }};
          
          const issueNumber = branchInfo.issueNumber;
          const branchName = branchInfo.branchName;
          
          // Issueæƒ…å ±ã‚’å–å¾—
          const issue = await github.rest.issues.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber
          });
          
          // æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯
          const existingPRs = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            head: `${context.repo.owner}:${branchName}`,
            state: 'open'
          });
          
          if (existingPRs.data.length > 0) {
            console.log(`PR already exists: #${existingPRs.data[0].number}`);
            return {
              created: false,
              existing: true,
              prNumber: existingPRs.data[0].number,
              issueNumber
            };
          }
          
          // PRã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒœãƒ‡ã‚£ã‚’ä½œæˆ
          const prTitle = `ğŸ¤– Auto-fix: ${issue.data.title} (closes #${issueNumber})`;
          const prBody = `## ğŸ¤– è‡ªå‹•å®Ÿè£… - Claude Code Max

### ğŸ“‹ æ¦‚è¦
ã“ã®PRã¯Claude Code Max (Opus 4)ã«ã‚ˆã£ã¦è‡ªå‹•å®Ÿè£…ã•ã‚ŒãŸissue #${issueNumber}ã®è§£æ±ºã§ã™ã€‚

### ğŸ”— é–¢é€£Issue
Closes #${issueNumber}

**Issue Title:** ${issue.data.title}

### ğŸ› ï¸ å®Ÿè£…å†…å®¹
Claude Code MaxãŒä»¥ä¸‹ã®ä½œæ¥­ã‚’è‡ªå‹•å®Ÿè¡Œã—ã¾ã—ãŸï¼š
- Issue "${issue.data.title}" ã¸ã®å¯¾å¿œ
- ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®å®Ÿè£…
- è‡ªå‹•ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰

### ğŸ” ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æƒ…å ±
- **Workflow ID:** ${contextInfo.workflowId}
- **Branch:** ${branchName}
- **Triggered by:** ${contextInfo.actor || 'claude'}
- **Commit SHA:** ${contextInfo.headSha}

### âœ… è‡ªå‹•ãƒã‚§ãƒƒã‚¯é …ç›®
- [x] Claude Code Maxã«ã‚ˆã‚‹å®Ÿè£…å®Œäº†
- [x] è‡ªå‹•ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
- [x] ã‚³ãƒŸãƒƒãƒˆç½²åæ¸ˆã¿
- [ ] äººé–“ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæ¨å¥¨ï¼‰
- [ ] æœ€çµ‚å‹•ä½œç¢ºèª

### ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. ã“ã®PRã®å¤‰æ›´å†…å®¹ã‚’ç¢ºèª
2. å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ä¿®æ­£ã‚’å®Ÿæ–½
3. ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
4. ãƒãƒ¼ã‚¸ã—ã¦æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤

---
ğŸ¤– **å®Œå…¨è‡ªå‹•ç”Ÿæˆ** - Claude Code Max (Opus 4)
âš¡ **è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼** - GitHub Actions workflow_run trigger
ğŸ“ **ã‚³ãƒŸãƒƒãƒˆç½²å** - å…¨ã¦ã®ã‚³ãƒŸãƒƒãƒˆã¯è‡ªå‹•ç½²åæ¸ˆã¿

**æ³¨æ„:** ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ãŒã€é‡è¦ãªå¤‰æ›´ã«ã¤ã„ã¦ã¯äººé–“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ¨å¥¨ã—ã¾ã™ã€‚`;
          
          // PRã‚’ä½œæˆ
          try {
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prTitle,
              head: branchName,
              base: 'main',
              body: prBody,
              draft: false
            });
            
            console.log(`Successfully created PR #${pr.data.number}`);
            
            // ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: [
                'claude-auto-generated',
                'ready-for-review',
                'auto-workflow',
                'claude-code-max'
              ]
            });
            
            return {
              created: true,
              prNumber: pr.data.number,
              issueNumber,
              prUrl: pr.data.html_url
            };
            
          } catch (error) {
            console.error('Failed to create PR:', error);
            return {
              created: false,
              error: error.message,
              issueNumber
            };
          }
    
    - name: Add completion comment to issue
      if: steps.create-pr.outputs.result && fromJSON(steps.create-pr.outputs.result).created
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const result = ${{ steps.create-pr.outputs.result }};
          
          const comment = `## ğŸ‰ è‡ªå‹•å®Ÿè£…å®Œäº†ï¼

Claude Code Max (Opus 4)ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…ãŒå®Œäº†ã—ã€PRãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

### ğŸ“‹ å®Ÿè£…çµæœ
- **PRç•ªå·:** #${result.prNumber}
- **PR URL:** ${result.prUrl}
- **å®Ÿè£…è€…:** Claude Code Max (Opus 4)
- **å®Ÿè¡Œæ–¹å¼:** å®Œå…¨è‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

### ğŸ” æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. [PR #${result.prNumber}](${result.prUrl}) ã®å†…å®¹ã‚’ç¢ºèª
2. å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½
3. ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
4. å•é¡ŒãŒãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œ

### ğŸ¤– è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼
- âœ… Issueè§£æå®Œäº†
- âœ… ã‚³ãƒ¼ãƒ‰å®Ÿè£…å®Œäº† 
- âœ… ãƒ–ãƒ©ãƒ³ãƒä½œæˆå®Œäº†
- âœ… PRä½œæˆå®Œäº†
- â³ ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…æ©Ÿä¸­

---
ğŸš€ **Claude Code Maxå®Œå…¨è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼** ã«ã‚ˆã‚‹å®Ÿè£…ã§ã™ã€‚`;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: result.issueNumber,
            body: comment
          });

  # Optional: Auto-merge with safety checks
  auto-merge-with-checks:
    needs: [auto-create-pr]
    if: needs.auto-create-pr.outputs.pr_created == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      checks: read
    
    steps:
    - name: Wait for CI checks
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const prNumber = ${{ needs.auto-create-pr.outputs.pr_number }};
          const maxWaitTime = 10 * 60 * 1000; // 10åˆ†
          const checkInterval = 30 * 1000; // 30ç§’
          const startTime = Date.now();
          
          console.log(`Waiting for CI checks on PR #${prNumber}...`);
          
          while (Date.now() - startTime < maxWaitTime) {
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // PR ã®ãƒãƒ¼ã‚¸å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            if (pr.data.mergeable === true && pr.data.mergeable_state === 'clean') {
              console.log('PR is ready for auto-merge');
              return { ready: true, mergeable: true };
            } else if (pr.data.mergeable === false) {
              console.log('PR has merge conflicts');
              return { ready: false, mergeable: false, reason: 'merge_conflict' };
            }
            
            console.log(`PR status: mergeable=${pr.data.mergeable}, state=${pr.data.mergeable_state}`);
            await new Promise(resolve => setTimeout(resolve, checkInterval));
          }
          
          console.log('Timeout waiting for CI checks');
          return { ready: false, timeout: true };
    
    - name: Auto-merge PR (if safe)
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const prNumber = ${{ needs.auto-create-pr.outputs.pr_number }};
          const issueNumber = ${{ needs.auto-create-pr.outputs.issue_number }};
          
          try {
            // Squash mergeã§ãƒãƒ¼ã‚¸
            const merge = await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              commit_title: `ğŸ¤– Auto-merge: Claude Code implementation for issue #${issueNumber}`,
              commit_message: `Automatically merged PR created by Claude Code Max for issue #${issueNumber}

ğŸ¤– Fully automated workflow
âš¡ Powered by Claude Code Max (Opus 4)
ğŸ”— Related issue: #${issueNumber}`,
              merge_method: 'squash'
            });
            
            console.log(`Successfully auto-merged PR #${prNumber}`);
            
            // Issue ã‚’è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });
            
            // å®Œäº†ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['claude-completed', 'auto-merged']
            });
            
            // å®Œäº†ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## âœ… å®Œå…¨è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼å®Œäº†ï¼

PR #${prNumber} ãŒæ­£å¸¸ã«ãƒãƒ¼ã‚¸ã•ã‚Œã€ã“ã®Issueã¯è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸã€‚

### ğŸŠ å®Ÿè£…çµæœ
- âœ… **ã‚³ãƒ¼ãƒ‰å®Ÿè£…:** Claude Code Max (Opus 4)
- âœ… **PRä½œæˆ:** è‡ªå‹•ç”Ÿæˆ
- âœ… **ãƒãƒ¼ã‚¸:** è‡ªå‹•å®Ÿè¡Œ
- âœ… **Issueå®Œäº†:** è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º

### ğŸ“Š å®Ÿè¡Œæ™‚é–“
Claude Codeã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ã‹ã‚‰è‡ªå‹•ãƒãƒ¼ã‚¸ã¾ã§å®Œå…¨è‡ªå‹•åŒ–ã•ã‚Œã¾ã—ãŸã€‚

---
ğŸš€ **Claude Code Maxå®Œå…¨è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼** - Zero human intervention required!`
            });
            
          } catch (error) {
            console.error('Auto-merge failed:', error);
            
            // ãƒãƒ¼ã‚¸å¤±æ•—ã‚’é€šçŸ¥
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## âš ï¸ è‡ªå‹•ãƒãƒ¼ã‚¸ã«å¤±æ•—

PR #${prNumber} ã®è‡ªå‹•ãƒãƒ¼ã‚¸ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒãƒ¼ã‚¸ãŒå¿…è¦ã§ã™ã€‚

**ã‚¨ãƒ©ãƒ¼:** ${error.message}

### ğŸ“‹ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. PR ã®å¤‰æ›´å†…å®¹ã‚’ç¢ºèª
2. ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚„å•é¡Œã‚’è§£æ±º
3. æ‰‹å‹•ã§ãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œ

ğŸ¤– è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼ã¯ä¸€éƒ¨å®Œäº†ã—ã¦ã„ã¾ã™ãŒã€äººé–“ã®ä»‹å…¥ãŒå¿…è¦ã§ã™ã€‚`
            });
          }