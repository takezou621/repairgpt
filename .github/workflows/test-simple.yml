name: Test Simple Automation

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Test Auto Implementation
      uses: actions/github-script@v7
      with:
        script: |
          console.log('🧪 Testing auto-implementation feature');
          
          // Issue検索
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'claude-processed',
            state: 'open',
            per_page: 5
          });
          
          console.log(`Found ${issues.data.length} issues with claude-processed label`);
          
          for (const issue of issues.data) {
            console.log(`Issue #${issue.number}: ${issue.title}`);
            
            // 基本的なブランチ検索
            const branches = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10
            });
            
            const issueNum = issue.number.toString();
            const matchingBranches = branches.data.filter(branch => 
              branch.name.toLowerCase().includes(`issue-${issueNum}`) ||
              (branch.name.toLowerCase().includes('claude') && branch.name.includes(issueNum))
            );
            
            if (matchingBranches.length === 0) {
              console.log(`⚠️ No branch found for Issue #${issue.number} - Would start auto-implementation`);
              
              // テストコメント追加
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '🧪 **テスト実行中** - 未着手Issue自動実装機能のテストを実行しました。\n\n実際の実装は行いませんが、この機能が正常に動作することを確認しました。'
              });
            } else {
              console.log(`✅ Found ${matchingBranches.length} branch(es) for Issue #${issue.number}`);
            }
          }