name: Claude Schedule Automation

on:
  schedule:
    # 5åˆ†ã”ã¨ã«å®Ÿè¡Œã—ã¦æœªå‡¦ç†ã®Claudeä½œæ¥­ã‚’ãƒã‚§ãƒƒã‚¯
    - cron: '*/5 * * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-and-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      metadata: read
      checks: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Find unprocessed Claude work
      id: find-work
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('ğŸ” Searching for unprocessed Claude work...');
          
          // 1. claude-processedãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ãªissueã‚’å–å¾—
          const processedIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'claude-processed',
            per_page: 100
          });
          
          console.log(`Found ${processedIssues.data.length} claude-processed issues`);
          
          // 2. å…¨ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
          const branches = await github.rest.repos.listBranches({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          const claudeBranches = branches.data.filter(branch => 
            branch.name.includes('claude/issue-') || 
            branch.name.includes('claude/') ||
            branch.name.match(/issue-\d+/)
          );
          
          console.log(`Found ${claudeBranches.length} potential Claude branches`);
          
          // 3. æ—¢å­˜ã®PRãŒãªã„ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯
          const existingPRs = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'all',
            per_page: 100
          });
          
          const prBranches = existingPRs.data.map(pr => pr.head.ref);
          
          // 4. æœªå‡¦ç†ã®ãƒ–ãƒ©ãƒ³ãƒã¨issueã‚’ç‰¹å®š
          const unprocessedWork = [];
          
          for (const issue of processedIssues.data) {
            // å¯¾å¿œã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã‚’æ¤œç´¢
            const correspondingBranch = claudeBranches.find(branch => 
              branch.name.includes(`issue-${issue.number}`) ||
              branch.name.includes(`${issue.number}`)
            );
            
            if (correspondingBranch && !prBranches.includes(correspondingBranch.name)) {
              // ãƒ–ãƒ©ãƒ³ãƒã¯ã‚ã‚‹ãŒPRãŒãªã„ = æœªå‡¦ç†
              unprocessedWork.push({
                issueNumber: issue.number,
                issueTitle: issue.title,
                branchName: correspondingBranch.name,
                issueUrl: issue.html_url
              });
              console.log(`ğŸ“‹ Found unprocessed work: Issue #${issue.number}, Branch: ${correspondingBranch.name}`);
            }
          }
          
          console.log(`ğŸ¯ Total unprocessed work found: ${unprocessedWork.length}`);
          
          return {
            found: unprocessedWork.length > 0,
            workItems: unprocessedWork,
            count: unprocessedWork.length
          };
    
    - name: Process unprocessed work
      if: fromJSON(steps.find-work.outputs.result).found
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const workResult = ${{ steps.find-work.outputs.result }};
          
          console.log(`ğŸš€ Processing ${workResult.count} unprocessed work items...`);
          
          for (const work of workResult.workItems) {
            console.log(`\nğŸ“ Processing Issue #${work.issueNumber}: ${work.issueTitle}`);
            
            try {
              // PRã‚’ä½œæˆ
              const prBody = `## ğŸ¤– Claude Code Max ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…

### é–¢é€£Issue
Closes #${work.issueNumber}

### æ¦‚è¦
Claude Code MaxãŒ Issue "${work.issueTitle}" ã‚’è§£æ±ºã—ã¾ã—ãŸã€‚

### å®Ÿè£…è©³ç´°
- **Issue**: #${work.issueNumber}
- **ãƒ–ãƒ©ãƒ³ãƒ**: \`${work.branchName}\`
- **ãƒˆãƒªã‚¬ãƒ¼**: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªå‹•æ¤œçŸ¥

### è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼
- [x] âœ… Claude Code Maxã«ã‚ˆã‚‹å®Ÿè£…å®Œäº†
- [x] âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªå‹•æ¤œçŸ¥
- [x] âœ… è‡ªå‹•PRä½œæˆ
- [ ] ğŸ”„ è‡ªå‹•ãƒãƒ¼ã‚¸
- [ ] ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
- [ ] ğŸ”„ ãƒ–ãƒ©ãƒ³ãƒè‡ªå‹•å‰Šé™¤

---
ğŸ¤– **å®Œå…¨è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼** | æ¤œçŸ¥æ–¹å¼: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« | Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>`;

              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `fix: ${work.issueTitle} (closes #${work.issueNumber})`,
                head: work.branchName,
                base: 'main',
                body: prBody
              });
              
              console.log(`âœ… Created PR #${pr.data.number}: ${pr.data.html_url}`);
              
              // ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: [
                  'claude-auto-generated',
                  'claude-full-automation',
                  'ready-for-merge'
                ]
              });
              
              // å°‘ã—å¾…ã£ã¦ã‹ã‚‰è‡ªå‹•ãƒãƒ¼ã‚¸
              console.log('â³ Waiting before auto-merge...');
              await new Promise(resolve => setTimeout(resolve, 15000));
              
              try {
                // è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
                const mergeResult = await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.data.number,
                  commit_title: `Auto-merge: Claude Code implementation for issue #${work.issueNumber}`,
                  commit_message: `Automatically merged PR #${pr.data.number} created by Claude Code Max for issue #${work.issueNumber}

ğŸ¤– Complete schedule automation flow executed successfully

Co-Authored-By: Claude <noreply@anthropic.com>`,
                  merge_method: 'squash'
                });
                
                console.log(`ğŸ‰ Successfully merged PR #${pr.data.number}`);
                
                // ãƒãƒ¼ã‚¸æˆåŠŸã‚’Issueã«å ±å‘Š
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: work.issueNumber,
                  body: `âœ… **å®Œå…¨è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå®Œäº†**

Claude Code Maxã«ã‚ˆã‚‹å®Ÿè£…ãŒæ­£å¸¸ã«å®Œäº†ã—ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªå‹•æ¤œçŸ¥ã«ã‚ˆã‚Šæœ¬ç•ªãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚

**å®Ÿè¡Œå†…å®¹:**
- ğŸ• ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªå‹•æ¤œçŸ¥ï¼ˆ5åˆ†é–“éš”ï¼‰
- ğŸ¤– Claude Code Maxã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…
- ğŸ“ è‡ªå‹•PRä½œæˆ: #${pr.data.number}
- âœ… è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
- ğŸ§¹ ãƒ–ãƒ©ãƒ³ãƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè¡Œï¼‰

**PR**: ${pr.data.html_url}

---
ğŸš€ **100%è‡ªå‹•åŒ–é”æˆ** | æ¤œçŸ¥æ–¹å¼: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« | Claude Code Max + GitHub Actions`
                });
                
                // Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: work.issueNumber,
                  state: 'closed'
                });
                
                // å®Œäº†ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: work.issueNumber,
                  labels: ['claude-completed', 'fully-automated']
                });
                
                console.log(`ğŸ”’ Closed issue #${work.issueNumber}`);
                
                // ãƒ–ãƒ©ãƒ³ãƒå‰Šé™¤
                await new Promise(resolve => setTimeout(resolve, 5000));
                
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${work.branchName}`
                });
                
                console.log(`ğŸ—‘ï¸ Deleted branch ${work.branchName}`);
                
              } catch (mergeError) {
                console.log(`âŒ Failed to merge PR #${pr.data.number}: ${mergeError.message}`);
                
                // ãƒãƒ¼ã‚¸å¤±æ•—ã‚’å ±å‘Š
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: work.issueNumber,
                  body: `âš ï¸ **è‡ªå‹•ãƒãƒ¼ã‚¸ã«å¤±æ•—**

PR #${pr.data.number} ã®è‡ªå‹•ãƒãƒ¼ã‚¸ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

**ã‚¨ãƒ©ãƒ¼è©³ç´°**: ${mergeError.message}

**PR**: ${pr.data.html_url}

æ‰‹å‹•ã§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒãƒ¼ã‚¸ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`
                });
              }
              
            } catch (prError) {
              console.log(`âŒ Failed to create PR for issue #${work.issueNumber}: ${prError.message}`);
            }
            
            // æ¬¡ã®å‡¦ç†ã¾ã§ã®é–“éš”
            await new Promise(resolve => setTimeout(resolve, 2000));
          }
          
          console.log('ğŸ‰ All unprocessed work has been processed!');
    
    - name: Summary report
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const workResult = ${{ steps.find-work.outputs.result || '{"found": false, "count": 0}' }};
          
          if (workResult.found) {
            console.log(`ğŸ“Š Schedule automation summary:`);
            console.log(`   - Processed items: ${workResult.count}`);
            console.log(`   - Status: Complete`);
            console.log(`   - Next check: In 5 minutes`);
          } else {
            console.log(`âœ¨ No unprocessed Claude work found. System is up to date.`);
          }
          
          console.log(`\nğŸ”„ Next scheduled check: ${new Date(Date.now() + 5 * 60 * 1000).toISOString()}`);