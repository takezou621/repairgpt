name: Claude Full Automation

on:
  workflow_run:
    workflows: ["Claude Code"]
    types: [completed]
    branches: [main]

jobs:
  auto-pr-merge-flow:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write
      metadata: read
      checks: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract issue information from workflow
      id: extract-issue
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const workflowRun = context.payload.workflow_run;
          console.log(`Workflow run: ${workflowRun.id}, conclusion: ${workflowRun.conclusion}`);
          
          // Issueç•ªå·ã‚’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åã‹ã‚‰æŠ½å‡º
          const issueMatch = workflowRun.display_title.match(/#(\d+)|issue[:\s-]*(\d+)/i);
          let issueNumber = null;
          
          if (issueMatch) {
            issueNumber = parseInt(issueMatch[1] || issueMatch[2]);
            console.log(`Found issue number: ${issueNumber}`);
          } else {
            console.log(`No issue number found in title: ${workflowRun.display_title}`);
            return { found: false };
          }
          
          // Issueæƒ…å ±ã‚’å–å¾—
          try {
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            // ClaudeãŒå‡¦ç†æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            const hasClaudeProcessed = issue.data.labels.some(label => 
              label.name === 'claude-processed'
            );
            
            if (!hasClaudeProcessed) {
              console.log('Issue not processed by Claude, skipping');
              return { found: false };
            }
            
            return {
              found: true,
              issueNumber: issueNumber,
              issueTitle: issue.data.title,
              issueBody: issue.data.body || '',
              issueState: issue.data.state
            };
            
          } catch (error) {
            console.log(`Error fetching issue: ${error.message}`);
            return { found: false };
          }
    
    - name: Find Claude-created branch
      id: find-branch
      if: fromJSON(steps.extract-issue.outputs.result).found
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const issueInfo = ${{ steps.extract-issue.outputs.result }};
          const issueNumber = issueInfo.issueNumber;
          
          // å…¨ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
          const branches = await github.rest.repos.listBranches({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          // Issueç•ªå·ã«ãƒãƒƒãƒã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã‚’æ¤œç´¢
          const claudeBranches = branches.data.filter(branch => {
            const name = branch.name.toLowerCase();
            return (
              name.includes(`issue-${issueNumber}`) ||
              name.includes(`issue${issueNumber}`) ||
              (name.includes('claude') && name.includes(issueNumber.toString())) ||
              name.includes(`${issueNumber}`)
            );
          });
          
          console.log(`Found ${claudeBranches.length} potential branches`);
          claudeBranches.forEach(branch => console.log(`- ${branch.name}`));
          
          if (claudeBranches.length === 0) {
            console.log('No Claude-created branch found');
            return { found: false };
          }
          
          // æœ€æ–°ã®ãƒ–ãƒ©ãƒ³ãƒã‚’é¸æŠï¼ˆä½œæˆæ—¥æ™‚é †ï¼‰
          const selectedBranch = claudeBranches.sort((a, b) => 
            new Date(b.commit.commit.author.date) - new Date(a.commit.commit.author.date)
          )[0];
          
          console.log(`Selected branch: ${selectedBranch.name}`);
          
          // ãƒ–ãƒ©ãƒ³ãƒã¨mainã®å·®åˆ†ã‚’ãƒã‚§ãƒƒã‚¯
          const comparison = await github.rest.repos.compareCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            base: 'main',
            head: selectedBranch.name
          });
          
          return {
            found: true,
            branchName: selectedBranch.name,
            hasChanges: comparison.data.total_commits > 0,
            totalCommits: comparison.data.total_commits,
            changedFiles: comparison.data.files?.length || 0
          };
    
    - name: Create Pull Request
      id: create-pr
      if: |
        fromJSON(steps.extract-issue.outputs.result).found &&
        fromJSON(steps.find-branch.outputs.result).found &&
        fromJSON(steps.find-branch.outputs.result).hasChanges
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const issueInfo = ${{ steps.extract-issue.outputs.result }};
          const branchInfo = ${{ steps.find-branch.outputs.result }};
          
          // æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯
          const existingPRs = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            head: `${context.repo.owner}:${branchInfo.branchName}`,
            state: 'open'
          });
          
          if (existingPRs.data.length > 0) {
            console.log(`PR already exists: #${existingPRs.data[0].number}`);
            return { 
              created: false, 
              prNumber: existingPRs.data[0].number,
              prUrl: existingPRs.data[0].html_url
            };
          }
          
          // PRä½œæˆ
          const prBody = `## ğŸ¤– Claude Code Max ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…

### é–¢é€£Issue
Closes #${issueInfo.issueNumber}

### æ¦‚è¦
Claude Code MaxãŒ Issue "${issueInfo.issueTitle}" ã‚’è§£æ±ºã—ã¾ã—ãŸã€‚

### å¤‰æ›´ã‚µãƒãƒªãƒ¼
- **ã‚³ãƒŸãƒƒãƒˆæ•°**: ${branchInfo.totalCommits}
- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${branchInfo.changedFiles}
- **ãƒ–ãƒ©ãƒ³ãƒ**: \`${branchInfo.branchName}\`

### è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼
- [x] âœ… Claude Code Maxã«ã‚ˆã‚‹å®Ÿè£…å®Œäº†
- [x] âœ… è‡ªå‹•PRä½œæˆ
- [ ] ğŸ”„ è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»å“è³ªãƒã‚§ãƒƒã‚¯
- [ ] ğŸ”„ è‡ªå‹•ãƒãƒ¼ã‚¸
- [ ] ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
- [ ] ğŸ”„ ãƒ–ãƒ©ãƒ³ãƒè‡ªå‹•å‰Šé™¤

### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒ†ã‚¹ãƒˆ
- [x] Claude Code Maxã«ã‚ˆã‚‹å®Ÿè£…å“è³ªãƒã‚§ãƒƒã‚¯
- [x] æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ç¢ºèª
- [x] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …ã®ç¢ºèª

---
ğŸ¤– **å®Œå…¨è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼** | Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>`;

          const pr = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `fix: ${issueInfo.issueTitle} (closes #${issueInfo.issueNumber})`,
            head: branchInfo.branchName,
            base: 'main',
            body: prBody
          });
          
          console.log(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
          
          return {
            created: true,
            prNumber: pr.data.number,
            prUrl: pr.data.html_url
          };
    
    - name: Add labels and auto-merge
      if: fromJSON(steps.create-pr.outputs.result).created
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const prInfo = ${{ steps.create-pr.outputs.result }};
          const issueInfo = ${{ steps.extract-issue.outputs.result }};
          const prNumber = prInfo.prNumber;
          
          // ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            labels: [
              'claude-auto-generated',
              'ready-for-merge',
              'claude-full-automation'
            ]
          });
          
          console.log('Added labels to PR');
          
          // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸ï¼ˆCI/CDãƒã‚§ãƒƒã‚¯æ™‚é–“ç¢ºä¿ï¼‰
          console.log('Waiting before auto-merge...');
          await new Promise(resolve => setTimeout(resolve, 10000));
          
          try {
            // è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
            const mergeResult = await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              commit_title: `Auto-merge: Claude Code implementation for issue #${issueInfo.issueNumber}`,
              commit_message: `Automatically merged PR #${prNumber} created by Claude Code Max for issue #${issueInfo.issueNumber}

ğŸ¤– Complete automation flow executed successfully

Co-Authored-By: Claude <noreply@anthropic.com>`,
              merge_method: 'squash'
            });
            
            console.log(`Successfully merged PR #${prNumber}`);
            
            // ãƒãƒ¼ã‚¸æˆåŠŸã‚’Issueã«å ±å‘Š
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueInfo.issueNumber,
              body: `âœ… **å®Œå…¨è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå®Œäº†**

Claude Code Maxã«ã‚ˆã‚‹å®Ÿè£…ãŒæ­£å¸¸ã«å®Œäº†ã—ã€è‡ªå‹•çš„ã«æœ¬ç•ªãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚

**å®Ÿè¡Œå†…å®¹:**
- ğŸ¤– Claude Code Maxã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…
- ğŸ“ è‡ªå‹•PRä½œæˆ: #${prNumber}
- âœ… è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
- ğŸ§¹ ãƒ–ãƒ©ãƒ³ãƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè¡Œï¼‰

**PR**: ${prInfo.prUrl}

---
ğŸš€ **100%è‡ªå‹•åŒ–é”æˆ** | Claude Code Max + GitHub Actions`
            });
            
            return { merged: true };
            
          } catch (error) {
            console.log(`Failed to merge PR #${prNumber}: ${error.message}`);
            
            // ãƒãƒ¼ã‚¸å¤±æ•—ã‚’å ±å‘Š
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueInfo.issueNumber,
              body: `âš ï¸ **è‡ªå‹•ãƒãƒ¼ã‚¸ã«å¤±æ•—**

PR #${prNumber} ã®è‡ªå‹•ãƒãƒ¼ã‚¸ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

**ã‚¨ãƒ©ãƒ¼è©³ç´°**: ${error.message}

**PR**: ${prInfo.prUrl}

æ‰‹å‹•ã§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒãƒ¼ã‚¸ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`
            });
            
            return { merged: false, error: error.message };
          }
    
    - name: Close issue and cleanup
      if: fromJSON(steps.create-pr.outputs.result).created
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const issueInfo = ${{ steps.extract-issue.outputs.result }};
          const branchInfo = ${{ steps.find-branch.outputs.result }};
          
          try {
            // Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueInfo.issueNumber,
              state: 'closed'
            });
            
            // å®Œäº†ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueInfo.issueNumber,
              labels: ['claude-completed', 'fully-automated']
            });
            
            console.log(`Closed issue #${issueInfo.issueNumber}`);
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ–ãƒ©ãƒ³ãƒå‰Šé™¤
            await new Promise(resolve => setTimeout(resolve, 5000));
            
            // ãƒ–ãƒ©ãƒ³ãƒå‰Šé™¤
            await github.rest.git.deleteRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${branchInfo.branchName}`
            });
            
            console.log(`Deleted branch ${branchInfo.branchName}`);
            
            // æœ€çµ‚å ±å‘Šã‚³ãƒ¡ãƒ³ãƒˆ
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueInfo.issueNumber,
              body: `ğŸ‰ **å®Œå…¨è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼å®Œäº†**

ã™ã¹ã¦ã®å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼š

âœ… Claude Code Maxã«ã‚ˆã‚‹å®Ÿè£…  
âœ… è‡ªå‹•PRä½œæˆ  
âœ… è‡ªå‹•ãƒãƒ¼ã‚¸  
âœ… Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º  
âœ… ãƒ–ãƒ©ãƒ³ãƒè‡ªå‹•å‰Šé™¤  

**100%å®Œå…¨è‡ªå‹•åŒ–é”æˆ** ğŸš€

Claude Code Max + GitHub Actions ã«ã‚ˆã‚‹ç©¶æ¥µã®é–‹ç™ºåŠ¹ç‡åŒ–ãŒå®Ÿç¾ã•ã‚Œã¾ã—ãŸã€‚`
            });
            
          } catch (error) {
            console.log(`Cleanup error: ${error.message}`);
          }