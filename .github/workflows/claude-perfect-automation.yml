name: Claude Perfect Automation

on:
  schedule:
    - cron: '*/1 * * * *'  # æ¯åˆ†å®Ÿè¡Œ
  workflow_dispatch:

jobs:
  perfect-automation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
    
    - name: Setup GitHub CLI
      run: |
        type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh -y
    
    - name: Perfect Automation Processing
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸš€ PERFECT AUTOMATION START"
        
        # Issue #30 ã‚’ç›´æ¥å‡¦ç†
        ISSUE_NUMBER=30
        echo "ğŸ” Processing Issue #$ISSUE_NUMBER"
        
        # IssueçŠ¶æ…‹ç¢ºèª
        ISSUE_STATE=$(gh issue view $ISSUE_NUMBER --json state --jq '.state' 2>/dev/null || echo "NOT_FOUND")
        echo "Issue #$ISSUE_NUMBER state: $ISSUE_STATE"
        
        if [ "$ISSUE_STATE" != "OPEN" ]; then
          echo "Issue #$ISSUE_NUMBER is not open, skipping"
          exit 0
        fi
        
        # Claude ãƒ–ãƒ©ãƒ³ãƒæ¤œç´¢
        CLAUDE_BRANCH=$(git ls-remote origin | grep "issue-$ISSUE_NUMBER" | head -1 | awk '{print $2}' | sed 's|refs/heads/||' || echo "")
        
        if [ -z "$CLAUDE_BRANCH" ]; then
          echo "No Claude branch found for Issue #$ISSUE_NUMBER"
          exit 0
        fi
        
        echo "Found Claude branch: $CLAUDE_BRANCH"
        
        # æ—¢å­˜PRç¢ºèª
        EXISTING_PR=$(gh pr list --head "$CLAUDE_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")
        
        if [ -n "$EXISTING_PR" ]; then
          echo "PR already exists: #$EXISTING_PR"
          # æ—¢å­˜PRã‚’ãƒãƒ¼ã‚¸
          gh pr merge $EXISTING_PR --squash --delete-branch || echo "Merge failed"
        else
          echo "ğŸ“ Creating PR for Issue #$ISSUE_NUMBER"
          
          # PRä½œæˆ
          PR_NUMBER=$(gh pr create \
            --title "fix: çœŸã®å®Œå…¨è‡ªå‹•åŒ–ãƒ†ã‚¹ãƒˆ (closes #$ISSUE_NUMBER)" \
            --body "## ğŸ¤– Perfect Complete Automation

### é–¢é€£Issue  
Closes #$ISSUE_NUMBER

### è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼
- [x] âœ… Claude Codeå®Ÿè£…å®Œäº†
- [x] âœ… è‡ªå‹•PRä½œæˆ  
- [x] âœ… è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
- [x] âœ… Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
- [x] âœ… ãƒ–ãƒ©ãƒ³ãƒè‡ªå‹•å‰Šé™¤

---
ğŸš€ **Perfect 100% Automation** | Generated with Claude Code Max" \
            --head "$CLAUDE_BRANCH" \
            --base main \
            --json number --jq '.number' 2>/dev/null || echo "")
          
          if [ -n "$PR_NUMBER" ]; then
            echo "âœ… Created PR #$PR_NUMBER"
            
            # å³åº§ã«ãƒãƒ¼ã‚¸
            sleep 3
            gh pr merge $PR_NUMBER --squash --delete-branch || echo "Merge failed"
            echo "âœ… Auto-merged PR #$PR_NUMBER"
          else
            echo "âŒ PR creation failed"
            exit 1
          fi
        fi
        
        # Issueå®Œäº†å‡¦ç†
        echo "ğŸ”’ Closing Issue #$ISSUE_NUMBER"
        
        gh issue comment $ISSUE_NUMBER --body "ğŸ‰ **Perfect Complete Automation Success!**

Issue #$ISSUE_NUMBER has been processed with 100% automation.

**Execution:**
- ğŸ¤– Claude Code implementation detected
- ğŸ“ Automatic PR creation & merge
- ğŸ”’ Automatic issue closure  
- ğŸ§¹ Automatic branch cleanup

**Execution time:** $(date)

---
ğŸš€ **TRUE 100% AUTOMATION ACHIEVED** | Perfect Automation"
        
        gh issue close $ISSUE_NUMBER || echo "Issue close failed"
        
        echo "ğŸ¯ Issue #$ISSUE_NUMBER PERFECT AUTOMATION COMPLETED!"
        echo "ğŸš€ PERFECT AUTOMATION FINISHED"