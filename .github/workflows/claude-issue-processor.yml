name: Claude Issue Processor

on:
  schedule:
    # æ¯æ—¥23:00(JST)ã«å®Ÿè¡Œï¼ˆæ·±å¤œå¸¯ã«å‡¦ç†ï¼‰
    - cron: '0 14 * * *'  # UTC 14:00 = JST 23:00
  workflow_dispatch:

jobs:
  process-issues:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Find and process unprocessed issues
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          
          console.log('ğŸ” Searching for unprocessed issues...');
          
          try {
            // æœªå‡¦ç†ã®issueã‚’æ¤œç´¢ï¼ˆclaude-processedãƒ©ãƒ™ãƒ«ãŒãªã„ã‚‚ã®ï¼‰
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: '',
              sort: 'created',
              direction: 'asc',
              per_page: 100
            });
            
            // claude-processedãƒ©ãƒ™ãƒ«ãŒãªã„issueã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const unprocessedIssues = [];
            for (const issue of issues.data) {
              const labels = issue.labels.map(label => label.name);
              if (!labels.includes('claude-processed') && !labels.includes('wontfix')) {
                unprocessedIssues.push(issue);
              }
            }
            
            if (unprocessedIssues.length === 0) {
              console.log('âœ… No unprocessed issues found');
              return;
            }
            
            // å„ªå…ˆåº¦ã§ã‚½ãƒ¼ãƒˆï¼ˆpriority:highãŒæœ€å„ªå…ˆï¼‰
            const priorityOrder = { 'priority:high': 1, 'priority:medium': 2, 'priority:low': 3 };
            unprocessedIssues.sort((a, b) => {
              const aPriority = a.labels.find(label => label.name.startsWith('priority:'));
              const bPriority = b.labels.find(label => label.name.startsWith('priority:'));
              
              const aOrder = aPriority ? priorityOrder[aPriority.name] || 4 : 4;
              const bOrder = bPriority ? priorityOrder[bPriority.name] || 4 : 4;
              
              return aOrder - bOrder;
            });
            
            // æœ€åˆã®æœªå‡¦ç†issueã‚’é¸æŠ
            const targetIssue = unprocessedIssues[0];
            console.log(`ğŸ¯ Processing issue #${targetIssue.number}: ${targetIssue.title}`);
            
            // @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å«ã‚€ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆClaude Code Maxç”¨ï¼‰
            const comment = `@claude ã“ã®issueã‚’è§£æ±ºã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ã—ã¦ä½œæ¥­ã‚’é€²ã‚ã¦ãã ã•ã„ï¼š
- æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¦ç´„ã«å¾“ã†
- é©åˆ‡ãªãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å«ã‚ã‚‹
- å¿…è¦ã«å¿œã˜ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å¾“ã†

**Note**: Claude Code Max (Opus 4)ã‚’ä½¿ç”¨ã—ã¦é«˜åº¦ãªåˆ†æã¨å®Ÿè£…ã‚’è¡Œã„ã¾ã™ã€‚

ä½œæ¥­ãŒå®Œäº†ã—ãŸã‚‰ã€å®Ÿè£…å†…å®¹ã®æ¦‚è¦ã‚’å ±å‘Šã—ã¦ãã ã•ã„ã€‚`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: targetIssue.number,
              body: comment
            });
            
            // claude-processedãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: targetIssue.number,
              labels: ['claude-processed']
            });
            
            console.log(`âœ… Issue #${targetIssue.number} has been marked for Claude processing`);
            
          } catch (error) {
            console.error('âŒ Error processing issues:', error);
            throw error;
          }
    
    - name: Wait for processing
      run: |
        echo "âœ… Issue has been marked for Claude processing"
        echo "ğŸ¤– Claude will process this issue asynchronously"
        # æ·±å¤œå¸¯ã®å‡¦ç†ãªã®ã§ã€å°‘ã—å¾…æ©Ÿã—ã¦ã‹ã‚‰çµ‚äº†
        sleep 60