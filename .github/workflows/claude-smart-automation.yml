name: Claude Smart Automation

on:
  schedule:
    # å¹³æ—¥: 23:00, 02:00, 05:00 JST (14:00, 17:00, 20:00 UTC)
    - cron: '0 14,17,20 * * 1-5'
    # åœŸæ—¥: 10:00, 14:00, 18:00, 22:00 JST (01:00, 05:00, 09:00, 13:00 UTC)
    - cron: '0 1,5,9,13 * * 0,6'
  workflow_dispatch:

jobs:
  smart-automation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Smart Issue Processing
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const now = new Date();
          const day = now.getDay(); // 0=Sunday, 6=Saturday
          const hour = now.getUTCHours();
          const isWeekend = day === 0 || day === 6;
          
          // APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯é–¢æ•°
          async function checkRateLimit() {
            const rateLimit = await github.rest.rateLimit.get();
            const remaining = rateLimit.data.rate.remaining;
            const resetTime = new Date(rateLimit.data.rate.reset * 1000);
            
            console.log(`ğŸ“Š API Rate Limit: ${remaining} remaining`);
            console.log(`ğŸ”„ Reset time: ${resetTime.toISOString()}`);
            
            // æ®‹ã‚ŠãŒ100æœªæº€ã®å ´åˆã¯å¾…æ©Ÿ
            if (remaining < 100) {
              const waitTime = resetTime - now;
              console.log(`â³ API rate limit low. Waiting ${Math.ceil(waitTime / 1000 / 60)} minutes...`);
              await new Promise(resolve => setTimeout(resolve, waitTime));
            }
            
            return remaining;
          }
          
          console.log(`ğŸ¤– Claude Smart Automation started`);
          console.log(`Current time: ${now.toISOString()}`);
          console.log(`Day: ${day}, Hour: ${hour}UTC, Weekend: ${isWeekend}`);
          
          // APIã‚³ãƒ¼ãƒ«å‰ã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯
          await checkRateLimit();
          
          // Issueæ¤œç´¢
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'claude-processed',
            state: 'open',
            sort: 'created',
            direction: 'asc'
          });

          if (issues.data.length === 0) {
            console.log('âœ… No issues to process');
            return;
          }

          console.log(`ğŸ“‹ Found ${issues.data.length} issues for processing`);

          for (const issue of issues.data) {
            console.log(`\nğŸ” Processing Issue #${issue.number}: ${issue.title}`);
            
            // é‡è¤‡å®Ÿè¡Œé˜²æ­¢: processing ãƒ©ãƒ™ãƒ«ã®ãƒã‚§ãƒƒã‚¯
            const hasProcessingLabel = issue.labels.some(label => label.name === 'claude-processing');
            if (hasProcessingLabel) {
              console.log(`âš ï¸ Issue #${issue.number} is already being processed. Skipping...`);
              continue;
            }
            
            try {
              // å‡¦ç†é–‹å§‹ã‚’ç¤ºã™ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['claude-processing']
              });
              
              // APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
              await checkRateLimit();
              // ãƒ–ãƒ©ãƒ³ãƒæ¤œç´¢ï¼ˆæŸ”è»Ÿãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ï¼‰
              const branches = await github.rest.repos.listBranches({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              // Instead of strict patterns, use inclusive search
              const claudeBranches = branches.data.filter(branch => {
                const branchLower = branch.name.toLowerCase();
                const issueNum = issue.number.toString();
                
                return (
                  branchLower.includes(`issue-${issueNum}`) ||
                  (branchLower.includes(`claude`) && branchLower.includes(issueNum)) ||
                  branchLower.includes(`fix-${issueNum}`) ||
                  branchLower.includes(`feature-${issueNum}`)
                );
              });
              
              if (claudeBranches.length === 0) {
                console.log(`âš ï¸ No branch found for Issue #${issue.number}`);
                console.log(`Available branches: ${branches.data.slice(0, 10).map(b => b.name).join(', ')}...`);
                continue;
              }
              
              // Use the first matching branch
              const targetBranch = claudeBranches[0];
              console.log(`âœ… Found branch: ${targetBranch.name} for Issue #${issue.number}`);
              
              if (claudeBranches.length > 1) {
                console.log(`â„¹ï¸ Multiple branches found: ${claudeBranches.map(b => b.name).join(', ')}`);
              }
              
              // æ—¢å­˜PRç¢ºèª
              const existingPRs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${targetBranch.name}`,
                state: 'all'
              });
              
              if (existingPRs.data.length > 0) {
                console.log(`ğŸ“ PR already exists: #${existingPRs.data[0].number}`);
                continue;
              }
              
              // PRä½œæˆ
              console.log(`ğŸš€ Creating PR for Issue #${issue.number}...`);
              
              const timeContext = isWeekend ? 'åœŸæ—¥æ˜¼é–“' : 'å¹³æ—¥å¤œé–“';
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `fix: ${issue.title} (closes #${issue.number})`,
                head: targetBranch.name,
                base: 'main',
                body: [
                  '## ğŸ¤– ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ',
                  '',
                  '### ğŸ• å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°',
                  `- **å®Ÿè¡Œæ™‚åˆ»**: ${now.toISOString()}`,
                  `- **å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰**: ${timeContext}è‡ªå‹•å®Ÿè¡Œ`,
                  `- **æ›œæ—¥**: ${['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][day]}æ›œæ—¥`,
                  '',
                  '### ğŸ“‹ é–¢é€£Issue',
                  `Closes #${issue.number}`,
                  '',
                  '### ğŸ”„ è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼',
                  '- [x] âœ… Issueè‡ªå‹•æ¤œçŸ¥',
                  '- [x] âœ… ãƒ–ãƒ©ãƒ³ãƒè‡ªå‹•ç™ºè¦‹',
                  '- [x] âœ… PRè‡ªå‹•ä½œæˆ',
                  '- [ ] ğŸ”„ è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œä¸­',
                  '- [ ] ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º',
                  '- [ ] ğŸ”„ ãƒ–ãƒ©ãƒ³ãƒè‡ªå‹•å‰Šé™¤',
                  '',
                  '### ğŸ“Š å®Ÿè¡Œè©³ç´°',
                  `- **Branch**: \`${targetBranch.name}\``,
                  `- **å®Ÿè¡Œç’°å¢ƒ**: GitHub Actions (${timeContext})`,
                  `- **è‡ªå‹•åŒ–ãƒ¬ãƒ™ãƒ«**: 100%å®Œå…¨è‡ªå‹•`,
                  '',
                  '---',
                  'ğŸš€ **ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–é”æˆ** | Generated with [Claude Code](https://claude.ai/code)',
                  '',
                  'Co-Authored-By: Claude <noreply@anthropic.com>'
                ].join('\n')
              });
              
              console.log(`âœ… Created PR #${pr.data.number}: ${pr.data.html_url}`);
              
              // ãƒ©ãƒ™ãƒ«è¿½åŠ 
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: ['claude-auto-generated', 'smart-automation']
              });
              
              // è‡ªå‹•ãƒãƒ¼ã‚¸ã®å¾…æ©Ÿ
              console.log('â³ Waiting before auto-merge...');
              await new Promise(resolve => setTimeout(resolve, 5000));
              
              // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
              console.log('ğŸ”’ Running security checks...');
              const securityIssues = [];
              
              // PRã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
              const prFiles = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.data.number
              });
              
              // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³
              const riskyPatterns = [
                /\.env$/,
                /\.env\./,
                /secret/i,
                /password/i,
                /token/i,
                /key/i,
                /credential/i,
                /config\/production/,
                /\.pem$/,
                /\.key$/,
                /\.crt$/
              ];
              
              // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®ã‚ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ‘ã‚¿ãƒ¼ãƒ³
              const riskyContentPatterns = [
                /password\s*=\s*['""][^'"]{8,}/i,
                /token\s*=\s*['""][^'"]{20,}/i,
                /api_key\s*=\s*['""][^'"]{20,}/i,
                /secret\s*=\s*['""][^'"]{10,}/i,
                /-----BEGIN.*PRIVATE KEY-----/i
              ];
              
              for (const file of prFiles.data) {
                // ãƒ•ã‚¡ã‚¤ãƒ«åãƒã‚§ãƒƒã‚¯
                const isRiskyFile = riskyPatterns.some(pattern => pattern.test(file.filename));
                if (isRiskyFile) {
                  securityIssues.push(`ğŸš¨ Risky file: ${file.filename}`);
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‘ãƒƒãƒå†…å®¹ï¼‰
                if (file.patch) {
                  const hasRiskyContent = riskyContentPatterns.some(pattern => pattern.test(file.patch));
                  if (hasRiskyContent) {
                    securityIssues.push(`ğŸš¨ Risky content in: ${file.filename}`);
                  }
                }
              }
              
              // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒç™ºè¦‹ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
              if (securityIssues.length > 0) {
                console.log(`âŒ Security issues found: ${securityIssues.length}`);
                securityIssues.forEach(issue => console.log(issue));
                
                // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.data.number,
                  body: [
                    'ğŸš¨ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯: è­¦å‘Š**',
                    '',
                    'ã“ã® PR ã«ã¯æ½œåœ¨çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š',
                    '',
                    ...securityIssues.map(issue => `- ${issue}`),
                    '',
                    'âš ï¸ **è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’åœæ­¢ã—ã¾ã—ãŸ**',
                    '',
                    'æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™ã€‚æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
                    '',
                    '---',
                    'ğŸ¤– è‡ªå‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯'
                  ].join('\n')
                });
                
                // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.data.number,
                  labels: ['security-review-required', 'blocked-auto-merge']
                });
                
                console.log('ğŸ›‘ Auto-merge blocked due to security concerns');
                continue; // æ¬¡ã®Issueã«é€²ã‚€
              }
              
              console.log('âœ… Security checks passed');
              
              // è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.data.number,
                  commit_title: `Smart automation: ${issue.title} (#${issue.number})`,
                  commit_message: `${timeContext}ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–ã«ã‚ˆã‚‹ãƒãƒ¼ã‚¸\n\nğŸš€ Generated with [Claude Code](https://claude.ai/code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>`,
                  merge_method: 'squash'
                });
                
                console.log(`ğŸ‰ Successfully merged PR #${pr.data.number}`);
                
                // æˆåŠŸé€šçŸ¥
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: [
                    'âœ… **ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–å®Œäº†ï¼**',
                    '',
                    `ğŸ• **å®Ÿè¡Œæ™‚åˆ»**: ${now.toISOString()}`,
                    `ğŸ“… **å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰**: ${timeContext}è‡ªå‹•å®Ÿè¡Œ`,
                    '',
                    '**å®Ÿè¡Œå†…å®¹:**',
                    '- ğŸ” Issueè‡ªå‹•æ¤œçŸ¥ãƒ»å‡¦ç†',
                    `- ğŸ“ PRè‡ªå‹•ä½œæˆ: #${pr.data.number}`,
                    '- âœ… è‡ªå‹•ãƒãƒ¼ã‚¸å®Œäº†',
                    '- ğŸ§¹ ãƒ–ãƒ©ãƒ³ãƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œä¸­',
                    '',
                    `**PR**: ${pr.data.html_url}`,
                    '',
                    '---',
                    'ğŸš€ **ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ** | Claude Code + GitHub Actions'
                  ].join('\n')
                });
                
                // Issueå®Œäº†å‡¦ç†
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                
                // å‡¦ç†å®Œäº†ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã€processingãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['claude-completed', 'smart-automation']
                });
                
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  name: 'claude-processing'
                });
                
                console.log(`ğŸ”’ Closed Issue #${issue.number}`);
                
                // ãƒ–ãƒ©ãƒ³ãƒå‰Šé™¤
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                try {
                  await github.rest.git.deleteRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: `heads/${targetBranch.name}`
                  });
                  
                  console.log(`ğŸ—‘ï¸ Deleted branch ${targetBranch.name}`);
                } catch (deleteError) {
                  console.log(`âš ï¸ Branch deletion failed: ${deleteError.message}`);
                }
                
                console.log(`ğŸ¯ SMART AUTOMATION COMPLETED FOR ISSUE #${issue.number}!`);
                
              } catch (mergeError) {
                console.log(`âŒ Merge failed for PR #${pr.data.number}: ${mergeError.message}`);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: [
                    'âš ï¸ ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–: ãƒãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼',
                    '',
                    `PR #${pr.data.number}: ${pr.data.html_url}`,
                    '',
                    `ã‚¨ãƒ©ãƒ¼: ${mergeError.message}`,
                    '',
                    'æ‰‹å‹•ãƒãƒ¼ã‚¸ãŒå¿…è¦ã§ã™ã€‚'
                  ].join('\n')
                });
              }
              
            } catch (error) {
              console.log(`âŒ Error processing Issue #${issue.number}: ${error.message}`);
              
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯processingãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  name: 'claude-processing'
                });
              } catch (removeLabelError) {
                // ãƒ©ãƒ™ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
              }
              
              // é‡å¤§ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€æ–°ã—ã„Issueã‚’ä½œæˆ
              if (error.status === 500 || error.status === 502 || error.status === 503) {
                try {
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `[è‡ªå‹•åŒ–ã‚¨ãƒ©ãƒ¼] Issue #${issue.number} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ`,
                    body: [
                      '## ã‚¨ãƒ©ãƒ¼è©³ç´°',
                      '',
                      `- **å…ƒã®Issue**: #${issue.number}`,
                      `- **ã‚¨ãƒ©ãƒ¼æ™‚åˆ»**: ${now.toISOString()}`,
                      `- **ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${error.status}`,
                      `- **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ${error.message}`,
                      '',
                      '## ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹',
                      '```',
                      error.stack || 'ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãªã—',
                      '```',
                      '',
                      '---',
                      'ğŸ¤– è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ'
                    ].join('\n'),
                    labels: ['bug', 'automation-error', 'high-priority']
                  });
                  console.log('ğŸ“ Created error issue for critical error');
                } catch (issueError) {
                  console.log(`Failed to create error issue: ${issueError.message}`);
                }
              }
              
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: [
                    'âŒ ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–ã‚¨ãƒ©ãƒ¼',
                    '',
                    `ã‚¨ãƒ©ãƒ¼: ${error.message}`,
                    `å®Ÿè¡Œæ™‚åˆ»: ${now.toISOString()}`,
                    '',
                    'æ‰‹å‹•ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚'
                  ].join('\n')
                });
              } catch (commentError) {
                console.log(`Failed to add error comment: ${commentError.message}`);
              }
            }
          }
          
          console.log('\nğŸš€ Claude Smart Automation completed!');