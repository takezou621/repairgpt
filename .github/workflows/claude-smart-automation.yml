name: Claude Smart Automation

on:
  schedule:
    # å¹³æ—¥: 23:00, 02:00, 05:00 JST (14:00, 17:00, 20:00 UTC)
    - cron: '0 14,17,20 * * 1-5'
    # åœŸæ—¥: 10:00, 14:00, 18:00, 22:00 JST (01:00, 05:00, 09:00, 13:00 UTC)
    - cron: '0 1,5,9,13 * * 0,6'
  workflow_dispatch:

jobs:
  smart-automation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Smart Issue Processing
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const now = new Date();
          const day = now.getDay(); // 0=Sunday, 6=Saturday
          const hour = now.getUTCHours();
          const isWeekend = day === 0 || day === 6;
          
          console.log(`ğŸ¤– Claude Smart Automation started`);
          console.log(`Current time: ${now.toISOString()}`);
          console.log(`Day: ${day}, Hour: ${hour}UTC, Weekend: ${isWeekend}`);
          
          // Issueæ¤œç´¢
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'claude-processed',
            state: 'open',
            sort: 'created',
            direction: 'asc'
          });

          if (issues.data.length === 0) {
            console.log('âœ… No issues to process');
            return;
          }

          console.log(`ğŸ“‹ Found ${issues.data.length} issues for processing`);

          for (const issue of issues.data) {
            console.log(`\nğŸ” Processing Issue #${issue.number}: ${issue.title}`);
            
            try {
              // ãƒ–ãƒ©ãƒ³ãƒæ¤œç´¢ï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
              const patterns = [
                `issue-${issue.number}`,
                `fix-issue-${issue.number}`,
                `claude-issue-${issue.number}`,
                `issue${issue.number}`
              ];
              
              const branches = await github.rest.repos.listBranches({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              let targetBranch = null;
              for (const pattern of patterns) {
                targetBranch = branches.data.find(branch => 
                  branch.name.toLowerCase().includes(pattern.toLowerCase())
                );
                if (targetBranch) {
                  console.log(`âœ… Found branch: ${targetBranch.name} (pattern: ${pattern})`);
                  break;
                }
              }
              
              if (!targetBranch) {
                console.log(`âš ï¸ No branch found for Issue #${issue.number}`);
                console.log(`Available branches: ${branches.data.slice(0, 10).map(b => b.name).join(', ')}...`);
                continue;
              }
              
              // æ—¢å­˜PRç¢ºèª
              const existingPRs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${targetBranch.name}`,
                state: 'all'
              });
              
              if (existingPRs.data.length > 0) {
                console.log(`ğŸ“ PR already exists: #${existingPRs.data[0].number}`);
                continue;
              }
              
              // PRä½œæˆ
              console.log(`ğŸš€ Creating PR for Issue #${issue.number}...`);
              
              const timeContext = isWeekend ? 'åœŸæ—¥æ˜¼é–“' : 'å¹³æ—¥å¤œé–“';
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `fix: ${issue.title} (closes #${issue.number})`,
                head: targetBranch.name,
                base: 'main',
                body: [
                  '## ğŸ¤– ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ',
                  '',
                  '### ğŸ• å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°',
                  `- **å®Ÿè¡Œæ™‚åˆ»**: ${now.toISOString()}`,
                  `- **å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰**: ${timeContext}è‡ªå‹•å®Ÿè¡Œ`,
                  `- **æ›œæ—¥**: ${['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][day]}æ›œæ—¥`,
                  '',
                  '### ğŸ“‹ é–¢é€£Issue',
                  `Closes #${issue.number}`,
                  '',
                  '### ğŸ”„ è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼',
                  '- [x] âœ… Issueè‡ªå‹•æ¤œçŸ¥',
                  '- [x] âœ… ãƒ–ãƒ©ãƒ³ãƒè‡ªå‹•ç™ºè¦‹',
                  '- [x] âœ… PRè‡ªå‹•ä½œæˆ',
                  '- [ ] ğŸ”„ è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œä¸­',
                  '- [ ] ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º',
                  '- [ ] ğŸ”„ ãƒ–ãƒ©ãƒ³ãƒè‡ªå‹•å‰Šé™¤',
                  '',
                  '### ğŸ“Š å®Ÿè¡Œè©³ç´°',
                  `- **Branch**: \`${targetBranch.name}\``,
                  `- **å®Ÿè¡Œç’°å¢ƒ**: GitHub Actions (${timeContext})`,
                  `- **è‡ªå‹•åŒ–ãƒ¬ãƒ™ãƒ«**: 100%å®Œå…¨è‡ªå‹•`,
                  '',
                  '---',
                  'ğŸš€ **ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–é”æˆ** | Generated with [Claude Code](https://claude.ai/code)',
                  '',
                  'Co-Authored-By: Claude <noreply@anthropic.com>'
                ].join('\n')
              });
              
              console.log(`âœ… Created PR #${pr.data.number}: ${pr.data.html_url}`);
              
              // ãƒ©ãƒ™ãƒ«è¿½åŠ 
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: ['claude-auto-generated', 'smart-automation']
              });
              
              // è‡ªå‹•ãƒãƒ¼ã‚¸ã®å¾…æ©Ÿ
              console.log('â³ Waiting before auto-merge...');
              await new Promise(resolve => setTimeout(resolve, 5000));
              
              // è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.data.number,
                  commit_title: `Smart automation: ${issue.title} (#${issue.number})`,
                  commit_message: `${timeContext}ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–ã«ã‚ˆã‚‹ãƒãƒ¼ã‚¸\n\nğŸš€ Generated with [Claude Code](https://claude.ai/code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>`,
                  merge_method: 'squash'
                });
                
                console.log(`ğŸ‰ Successfully merged PR #${pr.data.number}`);
                
                // æˆåŠŸé€šçŸ¥
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: [
                    'âœ… **ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–å®Œäº†ï¼**',
                    '',
                    `ğŸ• **å®Ÿè¡Œæ™‚åˆ»**: ${now.toISOString()}`,
                    `ğŸ“… **å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰**: ${timeContext}è‡ªå‹•å®Ÿè¡Œ`,
                    '',
                    '**å®Ÿè¡Œå†…å®¹:**',
                    '- ğŸ” Issueè‡ªå‹•æ¤œçŸ¥ãƒ»å‡¦ç†',
                    `- ğŸ“ PRè‡ªå‹•ä½œæˆ: #${pr.data.number}`,
                    '- âœ… è‡ªå‹•ãƒãƒ¼ã‚¸å®Œäº†',
                    '- ğŸ§¹ ãƒ–ãƒ©ãƒ³ãƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œä¸­',
                    '',
                    `**PR**: ${pr.data.html_url}`,
                    '',
                    '---',
                    'ğŸš€ **ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ** | Claude Code + GitHub Actions'
                  ].join('\n')
                });
                
                // Issueå®Œäº†å‡¦ç†
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['claude-completed', 'smart-automation']
                });
                
                console.log(`ğŸ”’ Closed Issue #${issue.number}`);
                
                // ãƒ–ãƒ©ãƒ³ãƒå‰Šé™¤
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                try {
                  await github.rest.git.deleteRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: `heads/${targetBranch.name}`
                  });
                  
                  console.log(`ğŸ—‘ï¸ Deleted branch ${targetBranch.name}`);
                } catch (deleteError) {
                  console.log(`âš ï¸ Branch deletion failed: ${deleteError.message}`);
                }
                
                console.log(`ğŸ¯ SMART AUTOMATION COMPLETED FOR ISSUE #${issue.number}!`);
                
              } catch (mergeError) {
                console.log(`âŒ Merge failed for PR #${pr.data.number}: ${mergeError.message}`);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: [
                    'âš ï¸ ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–: ãƒãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼',
                    '',
                    `PR #${pr.data.number}: ${pr.data.html_url}`,
                    '',
                    `ã‚¨ãƒ©ãƒ¼: ${mergeError.message}`,
                    '',
                    'æ‰‹å‹•ãƒãƒ¼ã‚¸ãŒå¿…è¦ã§ã™ã€‚'
                  ].join('\n')
                });
              }
              
            } catch (error) {
              console.log(`âŒ Error processing Issue #${issue.number}: ${error.message}`);
              
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: [
                    'âŒ ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–ã‚¨ãƒ©ãƒ¼',
                    '',
                    `ã‚¨ãƒ©ãƒ¼: ${error.message}`,
                    `å®Ÿè¡Œæ™‚åˆ»: ${now.toISOString()}`,
                    '',
                    'æ‰‹å‹•ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚'
                  ].join('\n')
                });
              } catch (commentError) {
                console.log(`Failed to add error comment: ${commentError.message}`);
              }
            }
          }
          
          console.log('\nğŸš€ Claude Smart Automation completed!');