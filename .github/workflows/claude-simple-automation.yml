name: Claude Simple Automation

on:
  schedule:
    - cron: '*/10 * * * *'  # 10åˆ†ã”ã¨ã«å®Ÿè¡Œï¼ˆé©åˆ‡ãªé »åº¦ã«èª¿æ•´ï¼‰
  workflow_dispatch:

jobs:
  process-claude-work:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Process Issues with "claude-processed" label
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('ğŸ” Searching for issues with "claude-processed" label...');
          
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'claude-processed',
            state: 'open'
          });

          if (issues.data.length === 0) {
            console.log('No processable issues found.');
            return;
          }

          for (const issue of issues.data) {
            console.log(`
--- Processing Issue #${issue.number}: ${issue.title} ---`);
            
            try {
              const branchNamePattern = `issue-${issue.number}`;
              
              // ãƒ–ãƒ©ãƒ³ãƒã®ç¢ºèª
              const branches = await github.rest.repos.listBranches({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              const claudeBranch = branches.data.find(branch => 
                branch.name.includes(branchNamePattern)
              );
              
              if (!claudeBranch) {
                console.log(`No Claude branch found for Issue #${issue.number}`);
                continue;
              }
              
              console.log(`Found branch: ${claudeBranch.name}`);
              
              // æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯
              const existingPRs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${claudeBranch.name}`,
                state: 'all'
              });
              
              if (existingPRs.data.length > 0) {
                console.log(`PR already exists for branch ${claudeBranch.name}: #${existingPRs.data[0].number}`);
                continue;
              }
              
              console.log(`ğŸš€ Creating PR for Issue #${issue.number}...`);
              
              // PRã‚’ä½œæˆ
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `fix: ${issue.title} (closes #${issue.number})`,
                head: claudeBranch.name,
                base: 'main',
                body: [
                  '## ğŸ¤– å®Œå…¨è‡ªå‹•åŒ–ã«ã‚ˆã‚‹PRä½œæˆ',
                  '',
                  '### é–¢é€£Issue',
                  `Closes #${issue.number}`,
                  '',
                  '### æ¦‚è¦',
                  'Claude Code Maxã«ã‚ˆã‚‹å®Ÿè£…ã‚’è‡ªå‹•æ¤œçŸ¥ã—ã€å®Œå…¨è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼ã§PRã‚’ä½œæˆã—ã¾ã—ãŸã€‚',
                  '',
                  '### å®Ÿè£…å†…å®¹',
                  `- Issue #${issue.number}: ${issue.title}`,
                  `- Branch: 
`${claudeBranch.name}``,
                  '- è‡ªå‹•æ¤œçŸ¥: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªå‹•åŒ–',
                  '',
                  '### è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼',
                  '- [x] âœ… Claude Code Maxã«ã‚ˆã‚‹å®Ÿè£…',
                  '- [x] âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªå‹•æ¤œçŸ¥',
                  '- [x] âœ… è‡ªå‹•PRä½œæˆ',
                  '- [ ] ğŸ”„ è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œä¸­',
                  '- [ ] ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º',
                  '- [ ] ğŸ”„ ãƒ–ãƒ©ãƒ³ãƒè‡ªå‹•å‰Šé™¤',
                  '',
                  '---',
                  'ğŸ¯ **çœŸã®100%å®Œå…¨è‡ªå‹•åŒ–é”æˆ** | Generated with [Claude Code](https://claude.ai/code)',
                  '',
                  'Co-Authored-By: Claude <noreply@anthropic.com>'
                ].join('
')
              });
              
              console.log(`âœ… Created PR #${pr.data.number}: ${pr.data.html_url}`);
              
              // ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: ['claude-auto-generated', 'fully-automated']
              });
              
              console.log('â³ Waiting before auto-merge...');
              await new Promise(resolve => setTimeout(resolve, 10000));
              
              // è‡ªå‹•ãƒãƒ¼ã‚¸
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.data.number,
                  commit_title: `Auto-merge: Issue #${issue.number} complete automation`,
                  merge_method: 'squash'
                });
                
                console.log(`ğŸ‰ Successfully merged PR #${pr.data.number}`);
                
                // Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: [
                    'âœ… **çœŸã®100%å®Œå…¨è‡ªå‹•åŒ–é”æˆï¼**',
                    '',
                    'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªå‹•åŒ–ã«ã‚ˆã‚Šã€äººé–“ã®ä»‹å…¥ãªã—ã§å®Œå…¨è‡ªå‹•å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚',
                    '',
                    '**å®Ÿè¡Œå†…å®¹:**',
                    '- ğŸ• ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚ˆã‚‹è‡ªå‹•æ¤œçŸ¥',
                    `- ğŸ“ è‡ªå‹•PRä½œæˆ: #${pr.data.number}`,
                    '- âœ… è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ',
                    '- ğŸ§¹ ãƒ–ãƒ©ãƒ³ãƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œä¸­',
                    '',
                    `**PR**: ${pr.data.html_url}`,
                    '',
                    '---',
                    'ğŸš€ **100%è‡ªå‹•åŒ–è¨¼æ˜å®Œäº†** | Claude Code Max + GitHub Actions'
                  ].join('
')
                });
                
                // Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                
                // å®Œäº†ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['claude-completed', 'fully-automated']
                });
                
                console.log(`ğŸ”’ Closed Issue #${issue.number}`);
                
                // ãƒ–ãƒ©ãƒ³ãƒå‰Šé™¤
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${claudeBranch.name}`
                });
                
                console.log(`ğŸ—‘ï¸ Deleted branch ${claudeBranch.name}`);
                
                console.log(`ğŸ¯ TRUE 100% AUTOMATION COMPLETED FOR ISSUE #${issue.number}!`);
                
              } catch (mergeError) {
                console.log(`âŒ Merge failed for PR #${pr.data.number}: ${mergeError.message}`);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: [
                    'âš ï¸ è‡ªå‹•ãƒãƒ¼ã‚¸ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
                    '',
                    `PR #${pr.data.number}: ${pr.data.html_url}`,
                    '',
                    `ã‚¨ãƒ©ãƒ¼: ${mergeError.message}`
                  ].join('
')
                });
              }
              
            } catch (error) {
              console.log(`âŒ Error processing Issue #${issue.number}: ${error.message}`);
            }
          }